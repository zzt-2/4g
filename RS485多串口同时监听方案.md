# RS485多串口同时监听方案

## 核心需求

- 可以同时监听多个已开启的串口数据
- 能够向任意已开启的串口发送数据
- 不需要活跃串口切换机制

## 关键修改点

### 存储层修改 (serialStore.ts)

- 从单串口模型改为多串口模型
- 使用Map或对象存储多个串口连接实例和状态
- 每个串口拥有自己的连接状态和数据缓存
- 提供简单的API用于：
  - 连接/断开指定串口
  - 获取所有已连接串口列表(使用现有的系统命令获取串口的方式)
  - 向指定串口发送数据
  - 清除指定串口的缓冲区

### 主进程修改 (serialHandlers.ts)

- 改为支持多串口实例管理
- 使用Map存储多个串口实例，以串口路径作为键
- 修改数据事件，发送时包含来源串口信息
- 所有API方法增加串口ID参数

### 类型修改 (serial.ts)

- 增加必要的多串口支持类型
- 简化接口，只保留核心功能

### 通信桥接修改 (electronApi.ts)

- 修改API方法以支持指定串口ID
- 数据监听回调增加串口来源信息

### UI组件修改

#### SerialPortList.vue

- 允许同时选择并连接多个串口
- 显示每个串口的独立状态
- 为每个串口提供连接/断开按钮

#### SerialOptionsForm.vue

- 允许为每个串口配置独立参数
- 简化界面，专注于核心配置

## 实现方式

- 避免不必要的复杂性，保持简单直观的API
- 确保数据来源明确，每条收到的数据都知道是从哪个串口来的
- 不需要复杂的分组和批处理机制
- 保持UI简洁，清晰显示多串口状态

## 修改顺序和步骤

按照依赖关系和逻辑顺序，建议按以下顺序进行修改：

### 1. 首先修改类型定义 (src/types/serial/serial.ts)

需要修改的内容：

- 增加多串口连接的类型定义
- 数据消息类型增加串口来源字段
- 修改连接状态类型以支持多串口场景

### 2. 修改主进程串口处理 (src-electron/main/ipc/serialHandlers.ts)

需要修改的内容：

- 将单一串口变量改为串口映射表（Map）
- 所有方法增加串口路径参数
- 修改数据事件发送机制，包含串口标识
- 修改状态管理，为每个串口维护独立状态

### 3. 更新通信桥接层 (src/utils/electronApi.ts)

需要修改的内容：

- 更新API接口以支持多串口参数
- 修改数据监听回调增加串口标识参数
- 增加批量操作的辅助方法（可选）

### 4. 重构状态存储 (src/stores/serialStore.ts)

需要修改的内容：

- 将单一串口状态改为串口状态映射
- 修改所有操作方法支持指定串口
- 增加已连接串口列表管理
- 修改数据接收处理逻辑，区分不同串口的数据

### 5. 更新UI组件

#### SerialPortList.vue

- 修改列表展示，使每个串口可独立操作
- 更新连接/断开逻辑，支持多串口同时连接
- 完善状态显示，清晰区分各串口状态

#### SerialOptionsForm.vue

- 修改表单以支持为不同串口设置独立参数
- 增加串口选择器（或连接已选取的串口）
- 优化参数应用逻辑

### 6. 进行测试和调试

- 测试多串口同时连接功能
- 验证数据正确发送到指定串口
- 确认每个串口的数据接收正常，且来源清晰
- 测试异常情况处理（如串口断开）
