# 动态表达式计算功能设计文档

## 功能概述

为发送帧和接收帧的字段添加动态值计算功能，使字段值能够根据其他参数（发送帧参数、接收帧数据、全局统计数据）的变化而动态更新。该功能通过自定义表达式实现，支持复杂的数学运算和条件判断。

## 1. 组件改进方案

### FrameFieldEditor 组件增强

- **保持组件统一性**：不拆分组件，在现有基础上添加发送/接收场景区分
- **最大化代码复用**：发送和接收使用同一套表达式系统
- **场景适配**：根据使用场景（发送/接收）显示相应的配置选项

## 2. 字段配置新增选项

### 2.1 数据参与类型选择（新增配置）

- **位置**：在发送用例配置的 checkbox 右边
- **控件类型**：select 下拉选择器
- **选项**：
  - **直接数据**：发送时参与组帧，接收时从帧中直接读取
  - **间接数据**：发送时不参与组帧（仅提供计算参数），接收时通过计算得出

### 2.2 输入类型选择（扩展现有）

- **现有选项**：输入框、下拉框、单选框
- **新增选项**：自定义表达式
- **注意**：数据参与类型与输入类型是两个独立的配置项

## 3. 自定义表达式功能

### 3.1 统一表达式系统

- 发送和接收使用同一套自定义表达式实现方案
- 最大化代码复用，避免重复开发
- 支持复杂的数学运算和逻辑判断

### 3.2 变量选择与映射

- **变量数量**：不限数量的变量选择
- **标识符**：每个变量对应简写标识符（如 "a", "ab", "ac"）
- **自引用支持**：支持字段自引用（如：`距离_新 = 距离_旧 + 步进`）
- **数据源类型**：
  - 当前帧的其他字段（包括自身）
  - 任意其他帧的字段数据
  - 全局统计数据

### 3.3 表达式处理机制

1. **输入**：用户输入包含简写标识符的表达式
2. **替换**：系统根据标识符替换为实际十进制数值
3. **执行**：使用 `new Function()` 执行 JavaScript 表达式
4. **输出**：返回计算结果

### 3.4 多条件表达式支持

- 支持配置多个表达式
- 每个表达式有对应的执行条件
- 根据参数值选择使用哪个表达式

## 4. 计算时机

### 4.1 发送帧

- **发送前计算**：在实际发送数据前进行表达式计算
- **手动刷新时计算**：用户主动刷新时重新计算
- **性能考虑**：不在接收时更新（避免性能问题）

### 4.2 接收帧

- **接收时计算**：接收到对应帧时立即进行表达式计算

## 5. 性能优化策略

### 5.1 缓存机制

- **变量值缓存**：记录上次计算使用的所有变量值
- **结果缓存**：缓存计算结果
- **智能更新**：
  - 对比当前值与缓存值
  - 值未变化时直接使用缓存结果
  - 值变化时重新计算并更新缓存

### 5.2 计算优化

- 避免不必要的重复计算
- 批量处理相关表达式
- 异步计算支持（如有需要）

## 6. 典型应用场景

### 6.1 发送帧间接数据应用

```
距离参数（间接数据）
- 用途：为其他字段提供计算基础
- 不参与组帧：仅作为计算参数

距离步进值（间接数据）
- 用途：每次发送时修改距离参数
- 自引用示例：新距离 = 旧距离 + 步进值
```

### 6.2 接收帧数据统计

```
字段累加统计
- 表达式：累计值 = 累计值 + 当前值

多字段运算
- 表达式：结果 = 字段A + 字段B * 字段C

条件计算
- 条件1：当 状态字段 == 1 时，使用表达式A
- 条件2：当 状态字段 == 2 时，使用表达式B
```

## 7. 数据结构设计

### 7.1 字段配置结构

```typescript
interface FieldConfig {
  // 现有字段
  id: string;
  name: string;
  type: FieldType;

  // 新增字段
  dataParticipationType: 'direct' | 'indirect'; // 数据参与类型
  inputType: 'input' | 'select' | 'radio' | 'expression'; // 输入类型
  expressionConfig?: ExpressionConfig; // 表达式配置（可选）
}
```

### 7.2 表达式配置结构

```typescript
interface ExpressionConfig {
  expressions: ConditionalExpression[]; // 多条件表达式
  variables: VariableMapping[]; // 变量映射
  cache?: {
    lastVariableValues: Record<string, any>;
    lastResult: any;
    timestamp: number;
  };
}

interface ConditionalExpression {
  condition: string; // 执行条件
  expression: string; // 表达式字符串
}

interface VariableMapping {
  identifier: string; // 简写标识符 (如 "a", "ab")
  sourceType: 'current_field' | 'frame_field' | 'global_stat';
  sourceId: string; // 数据源ID
  frameId?: string; // 帧ID（如果是帧相关）
  fieldId?: string; // 字段ID
}
```

### 7.3 数据源类型枚举

```typescript
enum DataSourceType {
  CURRENT_FIELD = 'current_field', // 当前帧字段（包括自引用）
  FRAME_FIELD = 'frame_field', // 其他帧字段
  GLOBAL_STAT = 'global_stat', // 全局统计数据
}
```

## 8. 实现注意事项

### 8.1 安全性

- 表达式执行需要进行安全检查
- 防止恶意代码注入
- 限制可执行的函数和操作

### 8.2 错误处理

- 表达式语法错误处理
- 变量不存在时的默认值
- 计算溢出或异常的处理

### 8.3 用户体验

- 表达式编辑器的语法高亮
- 变量自动补全功能
- 实时表达式验证
- 计算结果预览

## 9. 开发优先级

1. **基础表达式系统**：变量映射、表达式解析和执行
2. **字段配置扩展**：数据参与类型和输入类型选项
3. **缓存优化机制**：性能优化和智能更新
4. **多条件表达式**：条件判断和表达式选择
5. **用户界面优化**：编辑器增强和用户体验改进

---

_文档创建时间：2024年_
_最后更新：-_
