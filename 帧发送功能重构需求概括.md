# 帧发送功能重构需求概括

## 1. 核心问题分析

### 1.1 当前架构问题

- **功能分散**：顺序发送、定时发送、触发发送各自独立实现，代码重复度高
- **配置不统一**：定时和触发发送只支持单帧，无法复用顺序发送的多帧配置
- **配置格式不完善**：定时和触发的配置格式可能还没有完善，需要先完善
- **文件读写局限**：目前只有顺序发送支持配置文件读写，定时和触发配置无法持久化

### 1.2 当前实现状况

1. **顺序发送**：有独立对话框，支持多帧配置，可以读写配置文件
2. **定时发送**：单帧模式，配置界面在帧预览上方，配置格式可能不完善
3. **触发发送**：单帧模式，配置界面在帧预览上方，配置格式可能不完善
4. **文件机制**：每次打开会刷新读取固定文件，但没有存储定时和触发配置

### 1.3 用户真实需求

1. **扩展发送能力**：定时和触发发送都应支持多帧模式
2. **配置复用**：多帧的定时和触发发送应该能复用顺序发送的配置
3. **界面区分**：单帧和多帧场景使用不同的界面入口，避免复杂度
4. **配置持久化**：所有发送模式都应支持配置文件读写

## 2. 设计思路

### 2.1 核心理念

- **场景区分**：单帧场景（快速操作）vs 多帧场景（复杂配置）
- **界面复用**：多帧场景复用现有顺序发送对话框
- **配置独立**：定时和触发配置使用独立对话框，便于复用
- **最少修改**：尽量复用现有组件和逻辑

### 2.2 架构设计

```
发送场景分类：
├── 单帧场景
│   ├── 立即发送（现有）
│   ├── 定时发送（扩展配置格式）
│   └── 触发发送（扩展配置格式）
└── 多帧场景
    ├── 顺序发送（现有）
    ├── 定时发送（新增策略选项）
    └── 触发发送（新增策略选项）
```

## 3. 功能需求明确

### 3.1 单帧发送功能

1. **界面位置**：保持在帧预览区域上方的原有位置
2. **功能扩展**：
   - 立即发送（保持现有）
   - 定时发送：配置发送间隔、重复次数、开始时间等
   - 触发发送：配置监听来源、触发条件、响应动作等
3. **配置持久化**：支持保存/加载单帧发送配置

### 3.2 多帧发送功能

1. **界面复用**：复用现有顺序发送对话框
2. **策略选择**：在对话框中添加发送策略选项：
   - 立即发送（顺序执行，现有功能）
   - 定时发送（按间隔重复发送整个序列）
   - 触发发送（条件满足时发送整个序列）
3. **配置复用**：可以加载现有的顺序发送配置，然后选择不同的执行策略

### 3.3 独立配置对话框

1. **定时配置对话框**：
   - 发送间隔设置
   - 重复次数设置（支持无限循环）
   - 开始时间设置
   - 结束条件设置
2. **触发配置对话框**：
   - 监听来源选择
   - 触发帧选择
   - 触发条件配置（字段匹配、数值比较等）
   - 响应延时设置

## 4. 用户界面设计

### 4.1 界面布局

- **帧预览区域上方**：单帧发送按钮（立即/定时/触发）
- **主操作区域**：多帧发送按钮（打开顺序发送对话框）
- **任务监控区域**：显示所有活动的发送任务

### 4.2 操作流程

#### 4.2.1 单帧发送流程

1. 在帧预览区选择要发送的帧实例
2. 点击对应的发送按钮（立即/定时/触发）
3. 如果是定时或触发，打开对应的配置对话框
4. 配置完成后启动发送任务

#### 4.2.2 多帧发送流程

1. 点击"顺序发送"按钮打开对话框
2. 选择和配置多个帧实例
3. 选择发送策略（立即/定时/触发）
4. 如果选择定时或触发，打开对应的配置对话框
5. 配置完成后启动发送任务

### 4.3 配置文件管理

- **文件格式设计**：先完善定时和触发的配置格式
- **读写机制扩展**：支持单帧和多帧配置的保存/加载
- **兼容性考虑**：保持现有文件格式的兼容性

## 5. 技术实现要求

### 5.1 配置格式设计（优先级最高）

1. **定时发送配置格式**：

   ```typescript
   interface TimedSendConfig {
     interval: number; // 发送间隔（毫秒）
     repeatCount: number; // 重复次数（0表示无限）
     startDelay?: number; // 开始延时
     endCondition?: string; // 结束条件
   }
   ```

2. **触发发送配置格式**：

   ```typescript
   interface TriggerSendConfig {
     sourceId: string; // 监听来源ID
     triggerFrameId: string; // 触发帧ID
     conditions: ConditionRule[]; // 触发条件列表
     responseDelay?: number; // 响应延时
   }
   ```

3. **统一任务配置格式**：
   ```typescript
   interface SendTaskConfig {
     name: string;
     type: 'immediate' | 'timed' | 'triggered';
     instances: FrameInstanceConfig[];
     strategy?: TimedSendConfig | TriggerSendConfig;
   }
   ```

### 5.2 组件设计

1. **复用现有组件**：

   - 顺序发送对话框（扩展策略选择）
   - 帧实例选择器
   - 目标配置器

2. **新增独立组件**：
   - 定时配置对话框
   - 触发配置对话框
   - 任务监控器

### 5.3 文件读写机制（最后实现）

1. **扩展现有机制**：支持不同类型配置的读写
2. **文件命名策略**：区分单帧和多帧配置文件
3. **自动刷新机制**：扩展到支持所有配置类型

## 6. 实现优先级

### 6.1 第一阶段：配置格式设计

- 完善定时发送配置数据结构
- 完善触发发送配置数据结构
- 设计统一的任务配置格式
- 确保与现有配置的兼容性

### 6.2 第二阶段：独立配置对话框

- 创建定时配置对话框组件
- 创建触发配置对话框组件
- 实现配置验证和默认值处理

### 6.3 第三阶段：扩展多帧支持

- 在顺序发送对话框中添加策略选择
- 集成定时和触发配置对话框
- 实现多帧发送的任务管理

### 6.4 第四阶段：完善文件读写

- 扩展配置文件读写机制
- 支持单帧和多帧配置的持久化
- 优化自动刷新和文件管理

## 7. 成功标准

1. **功能完整**：

   - 单帧支持立即/定时/触发发送
   - 多帧支持立即/定时/触发发送
   - 配置可以跨模式复用

2. **界面友好**：

   - 单帧和多帧有清晰的界面区分
   - 独立的配置对话框，操作简洁
   - 任务状态监控直观

3. **数据完整**：

   - 所有配置都支持文件读写
   - 配置格式完善且向后兼容
   - 自动刷新机制完善

4. **代码质量**：
   - 最大化复用现有组件
   - 新增代码结构清晰
   - 易于维护和扩展

这个需求概括是否准确反映了你的实际需求？如果确认无误，我将基于此重新设计技术方案。
